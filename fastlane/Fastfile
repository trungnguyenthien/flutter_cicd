default_platform(:android)

platform :android do
  desc "Clean, build vÃ  deploy Android lÃªn Firebase App Distribution"
  lane :deploy_android do
    UI.message("ğŸ§¹ Dá»n dáº¹p project Flutter trÆ°á»›c khi build...")
    sh("flutter", "clean")

    UI.message("ğŸ“¦ CÃ i Ä‘áº·t láº¡i dependencies...")
    sh("flutter", "pub", "get")

    # Giáº£i mÃ£ file JSON tá»« biáº¿n mÃ´i trÆ°á»ng
    UI.message("ğŸ” Giáº£i mÃ£ service account JSON tá»« biáº¿n mÃ´i trÆ°á»ng...")
    File.open("firebase_service_account.json", "w") do |f|
      decoded = Base64.decode64(ENV["FIREBASE_SERVICE_ACCOUNT"])
      f.write(decoded)
    end

    # Máº·c Ä‘á»‹nh version code = 1
    build_number = 1

    begin
      UI.message("ğŸ” Äang láº¥y thÃ´ng tin release má»›i nháº¥t tá»« Firebase App Distribution...")
      latest_release = firebase_app_distribution_get_latest_release(
        app: ENV["YOUR_ANDROID_APP_ID"],
        service_credentials_file: "fastlane/firebase_service_account.json"
      )

      if latest_release && latest_release[:buildVersion]
        build_number = latest_release[:buildVersion].to_i + 1
        UI.message("âœ… PhÃ¡t hiá»‡n release trÆ°á»›c Ä‘Ã³, build number má»›i: #{build_number}")
      else
        UI.message("âš ï¸ KhÃ´ng tÃ¬m tháº¥y release trÆ°á»›c Ä‘Ã³, dÃ¹ng version máº·c Ä‘á»‹nh: #{build_number}")
      end
    rescue => e
      UI.message("âš ï¸ KhÃ´ng thá»ƒ láº¥y latest release (#{e.message}), build vá»›i version máº·c Ä‘á»‹nh: #{build_number}")
    end

    UI.message("ğŸ—ï¸ Báº¯t Ä‘áº§u build APK vá»›i build number #{build_number}...")
    sh("flutter", "build", "apk", "--build-number=#{build_number}", "--release")

    UI.message("ğŸš€ Upload lÃªn Firebase App Distribution...")
    firebase_app_distribution(
      app: ENV["YOUR_ANDROID_APP_ID"],
      service_credentials_file: "fastlane/firebase_service_account.json",
      android_artifact_path: "build/app/outputs/flutter-apk/app-release.apk",
      groups: "qa-team, dev-team",
      release_notes: "New build from Bitbucket Pipeline (build #{build_number})"
    )

    UI.success("ğŸ‰ Deploy thÃ nh cÃ´ng lÃªn Firebase App Distribution!")
  end
end
